<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ãƒãƒ£ãƒƒãƒˆ</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            ğŸ¤– AI ãƒãƒ£ãƒƒãƒˆ
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message ai-message">
                ã“ã‚“ã«ã¡ã¯ï¼ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã­ ğŸ˜Š
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." />
            <button id="sendButton">é€ä¿¡</button>
        </div>
    </div>
    
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
    <!-- Firebase v9 (æ­£ã—ã„CDN) -->
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore-compat.js"></script>
    
    <script>
        // ===== è¨­å®šæƒ…å ± =====
        // âš ï¸ ã“ã‚Œã‚‰ã®å€¤ã‚’å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„
        const GEMINI_API_KEY = ''; // Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "",
            authDomain: "kadai05-api-4fc7c.firebaseapp.com",
            projectId: "kadai05-api-4fc7c",
            storageBucket: "kadai05-api-4fc7c.firebasestorage.app",
            messagingSenderId: "886798501545",
            appId: "1:886798501545:web:3e2aea73817053f0d40bb8"
        };

        // FirebaseåˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('FirebaseåˆæœŸåŒ–æˆåŠŸ');
        } catch (error) {
            console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        }

        // ===== ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ =====
        class ChatApp {
            constructor() {
                this.chatMessages = $('#chatMessages');
                this.messageInput = $('#messageInput');
                this.sendButton = $('#sendButton');
                this.isLoading = false;

                this.initializeEvents();
                this.loadChatHistory();
                this.validateAPIKey(); // APIã‚­ãƒ¼æ¤œè¨¼ã‚’è¿½åŠ 
            }

            // APIã‚­ãƒ¼ã®æ¤œè¨¼
            async validateAPIKey() {
                if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                    return;
                }

                try {
                    await this.callGeminiAPI('ã“ã‚“ã«ã¡ã¯');
                    console.log('APIã‚­ãƒ¼æ¤œè¨¼æˆåŠŸ');
                    this.addMessage('APIã®æ¥ç¶šãŒç¢ºèªã§ãã¾ã—ãŸï¼', 'ai');
                } catch (error) {
                    console.error('APIã‚­ãƒ¼æ¤œè¨¼å¤±æ•—:', error);
                    this.addMessage(`âŒ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ai');
                }
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            initializeEvents() {
                // é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯
                this.sendButton.on('click', () => {
                    this.sendMessage();
                });

                // Enterã‚­ãƒ¼ã§é€ä¿¡
                this.messageInput.on('keypress', (e) => {
                    if (e.which === 13 && !this.isLoading) {
                        this.sendMessage();
                    }
                });
            }

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
            async sendMessage() {
                const message = this.messageInput.val().trim();
                if (!message || this.isLoading) return;

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                this.addMessage(message, 'user');
                this.messageInput.val('');
                this.setLoading(true);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                const loadingElement = this.addMessage('è€ƒãˆã¦ã„ã¾ã™...', 'loading');

                try {
                    // Gemini APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                    const aiResponse = await this.callGeminiAPI(message);

                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                    loadingElement.remove();

                    // AIã®å›ç­”ã‚’è¡¨ç¤º
                    this.addMessage(aiResponse, 'ai');

                    // Firebaseã«ä¿å­˜
                    await this.saveToFirebase(message, aiResponse);

                } catch (error) {
                    console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    loadingElement.remove();
                    this.addMessage('ã™ã¿ã¾ã›ã‚“ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚', 'ai');
                } finally {
                    this.setLoading(false);
                }
            }

            // Gemini APIã‚’å‘¼ã³å‡ºã—
            async callGeminiAPI(message) {
                // æ­£ã—ã„Gemini API URLï¼ˆ2025å¹´ç‰ˆï¼‰
                const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

                const data = {
                    contents: [{
                        parts: [{
                            text: message
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    }
                };

                try {
                    console.log('Gemini APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...', url);

                    const response = await axios.post(url, data, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        timeout: 30000 // 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                    });

                    console.log('Gemini APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.data);

                    if (response.data && response.data.candidates && response.data.candidates[0]) {
                        const aiResponse = response.data.candidates[0].content.parts[0].text;
                        return aiResponse;
                    } else {
                        console.error('äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ :', response.data);
                        throw new Error('APIã‹ã‚‰ã®å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“');
                    }
                } catch (error) {
                    console.error('Gemini API ã‚¨ãƒ©ãƒ¼è©³ç´°:');
                    console.error('- Status:', error.response?.status);
                    console.error('- Status Text:', error.response?.statusText);
                    console.error('- Response Data:', error.response?.data);
                    console.error('- Error Message:', error.message);

                    if (error.response?.status === 400) {
                        throw new Error('APIã‚­ãƒ¼ãŒç„¡åŠ¹ã‹ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼ãŒé–“é•ã£ã¦ã„ã¾ã™');
                    } else if (error.response?.status === 403) {
                        throw new Error('APIã‚­ãƒ¼ã®æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                    } else if (error.response?.status === 404) {
                        throw new Error('APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                    } else {
                        throw new Error(`APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                    }
                }
            }

            // Firebaseã«ä¼šè©±ã‚’ä¿å­˜
            async saveToFirebase(userMessage, aiResponse) {
                try {
                    await db.collection('chats').add({
                        userMessage: userMessage,
                        aiResponse: aiResponse,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('Firebaseã«ä¿å­˜ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            // éå»ã®ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
            async loadChatHistory() {
                if (!db) {
                    console.log('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€å±¥æ­´ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“');
                    return;
                }

                try {
                    const snapshot = await db.collection('chats')
                        .orderBy('timestamp', 'desc')
                        .limit(20)
                        .get();

                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push(doc.data());
                    });

                    // æ–°ã—ã„é †â†’å¤ã„é †ã«ä¸¦ã³æ›¿ãˆ
                    messages.reverse();

                    // å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆæœ€åˆã®æŒ¨æ‹¶ã¯æ®‹ã™ï¼‰
                    messages.forEach(msg => {
                        this.addMessage(msg.userMessage, 'user');
                        this.addMessage(msg.aiResponse, 'ai');
                    });

                } catch (error) {
                    console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¿½åŠ 
            addMessage(text, type) {
                let className = 'message ';
                if (type === 'user') {
                    className += 'user-message';
                } else if (type === 'ai') {
                    className += 'ai-message';
                } else if (type === 'loading') {
                    className += 'loading';
                }

                const messageElement = $(`<div class="${className}">${text}</div>`);
                this.chatMessages.append(messageElement);
                this.scrollToBottom();

                return messageElement;
            }

            // ç”»é¢ã‚’ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            scrollToBottom() {
                this.chatMessages.scrollTop(this.chatMessages[0].scrollHeight);
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
            setLoading(loading) {
                this.isLoading = loading;
                this.sendButton.prop('disabled', loading);
                this.messageInput.prop('disabled', loading);

                if (loading) {
                    this.sendButton.text('é€ä¿¡ä¸­...');
                } else {
                    this.sendButton.text('é€ä¿¡');
                }
            }
        }

        // ã‚¢ãƒ—ãƒªé–‹å§‹
        $(document).ready(() => {
            // Firebaseèª­ã¿è¾¼ã¿ç¢ºèª
            if (typeof firebase === 'undefined') {
                $('#chatMessages').append('<div class="error-message">âš ï¸ FirebaseãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚CDNã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>');
                return;
            }

            // APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                $('#chatMessages').append('<div class="error-message">âš ï¸ Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>');
                return;
            }

            if (firebaseConfig.apiKey === 'YOUR_FIREBASE_API_KEY') {
                $('#chatMessages').append('<div class="error-message">âš ï¸ Firebaseè¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>');
                return;
            }

            new ChatApp();
        });

    </script>
    
</body>
</html>